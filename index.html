<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drahtkombinator</title>

  <!-- ✅ Bootstrap 5 (modernes Design) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    body { background: #f6f7f8; }
    .card-soft { border: 0; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .badge-soft-pos { background: rgba(25,135,84,.12); color: #198754; border: 1px solid rgba(25,135,84,.25); }
    .badge-soft-neg { background: rgba(220,53,69,.12); color: #dc3545; border: 1px solid rgba(220,53,69,.25); }
    .result-pos { background: linear-gradient(180deg, rgba(25,135,84,.08), rgba(25,135,84,.02)); border: 1px solid rgba(25,135,84,.18); }
    .result-neg { background: linear-gradient(180deg, rgba(220,53,69,.08), rgba(220,53,69,.02)); border: 1px solid rgba(220,53,69,.18); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const e = React.createElement;

    function area(d) {
      return Math.PI * d * d / 4;
    }

    function App() {
      const [rows, setRows] = React.useState(Array(4).fill({ d: "", n: "" }));
      const [maxDev, setMaxDev] = React.useState(10);
      const [tolMinus, setTolMinus] = React.useState(0.2);
      const [tolPlus, setTolPlus] = React.useState(0.2);
      const [pdfName, setPdfName] = React.useState("");
      const [results, setResults] = React.useState([]);
      const [status, setStatus] = React.useState("");

      function updateRow(i, key, val) {
        const r = [...rows];
        r[i] = { ...r[i], [key]: val };
        setRows(r);
      }

      function calculate() {
        setStatus("");
        let stock = [];
        let minD = Infinity;
        let maxD = -Infinity;

        rows.forEach(r => {
          const d = parseFloat(String(r.d).replace(",", "."));
          const n = parseInt(String(r.n), 10);
          if (!isNaN(d) && !isNaN(n) && n > 0) {
            minD = Math.min(minD, d);
            maxD = Math.max(maxD, d);
            for (let i = 0; i < n; i++) stock.push(d);
          }
        });

        if (!stock.length || !isFinite(minD)) {
          setResults([]);
          setStatus("Bitte mindestens einen Draht-Durchmesser + Anzahl eingeben.");
          return;
        }

        const minAllowed = minD - tolMinus;
        const maxAllowed = maxD + tolPlus;
        stock = stock.filter(d => d >= minAllowed && d <= maxAllowed);

        if (!stock.length) {
          setResults([]);
          setStatus("Keine Drähte im zulässigen Bereich (min/max ± Toleranz).");
          return;
        }

        const target = area(minD);

        // ✅ Suche: max 1000 Kombis, max 5 Drähte
        let combis = [];
        for (let i = 0; i < stock.length && combis.length < 1000; i++) {
          let sum = 0;
          let used = [];
          for (let j = i; j < stock.length; j++) {
            if (used.length >= 5) break; // ✅ maximal 5 Drähte
            sum += area(stock[j]);
            used.push(stock[j]);

            const dev = (sum - target) / target * 100;
            if (Math.abs(dev) <= maxDev) {
              combis.push({ used: [...used], dev });
            }
          }
        }

        if (!combis.length) {
          setResults([]);
          setStatus("Keine Kombination innerhalb der Abweichung gefunden (ggf. Abweichung erhöhen).");
          return;
        }

        const plusList = combis
          .filter(c => c.dev >= 0)
          .sort((a, b) => a.dev - b.dev);

        const minusList = combis
          .filter(c => c.dev < 0)
          .sort((a, b) => b.dev - a.dev); // näher an 0 ist besser

        let out = [];

        // Titel-Logik wie von dir gewünscht:
        // Kombi 1: beste positive wenn vorhanden sonst beste negative
        // Kombi 2: immer negativ; wenn Kombi 1 bereits beste negative -> Kombi 2 = zweitbeste negative und Titel nur "negativ"
        if (plusList.length > 0) {
          out.push({ ...plusList[0], title: "Kombination 1 (beste positive)" });

          if (minusList.length > 0) {
            out.push({ ...minusList[0], title: "Kombination 2 (beste negative)" });
          }
        } else if (minusList.length > 0) {
          out.push({ ...minusList[0], title: "Kombination 1 (beste negative)" });

          if (minusList.length > 1) {
            out.push({ ...minusList[1], title: "Kombination 2 (negativ)" });
          }
        }

        setResults(out);
      }

      function resetAll() {
        setRows(Array(4).fill({ d: "", n: "" }));
        setMaxDev(10);
        setTolMinus(0.2);
        setTolPlus(0.2);
        setPdfName("");
        setResults([]);
        setStatus("");
      }

      function savePDF() {
        // Platzhalter – echte PDF können wir später mit jsPDF einbauen
        alert("PDF speichern: " + (pdfName || "drahtkombination"));
      }

      return e("div", { className: "container py-4" },

        e("div", { className: "card card-soft rounded-4 mb-4" },
          e("div", { className: "card-body p-4" },
            e("div", { className: "d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3" },
              e("div", null,
                e("h2", { className: "mb-1" }, "Drahtkombinator"),
                e("div", { className: "text-secondary" },
                  "Gib Lager-Drähte ein – ich suche die besten Kombinationen (max. 5 Drähte)."
                )
              ),
              e("div", { className: "d-flex gap-2 flex-wrap" },
                e("button", { className: "btn btn-primary", onClick: calculate }, "Berechnen"),
                e("button", { className: "btn btn-outline-secondary", onClick: resetAll }, "Reset")
              )
            )
          )
        ),

        e("div", { className: "row g-3" },

          // Eingaben
          e("div", { className: "col-12 col-lg-7" },
            e("div", { className: "card card-soft rounded-4" },
              e("div", { className: "card-body p-4" },
                e("h5", { className: "mb-3" }, "Lagerbestand"),

                rows.map((r, i) =>
                  e("div", { key: i, className: "row g-2 align-items-center mb-2" },

                    e("div", { className: "col-7 col-md-8" },
                      e("div", { className: "input-group" },
                        e("span", { className: "input-group-text" }, "Ø"),
                        e("input", {
                          className: "form-control",
                          placeholder: "Durchmesser (mm)",
                          value: r.d,
                          onChange: ev => updateRow(i, "d", ev.target.value)
                        }),
                        e("span", { className: "input-group-text" }, "mm")
                      )
                    ),

                    e("div", { className: "col-5 col-md-4" },
                      e("div", { className: "input-group" },
                        e("span", { className: "input-group-text" }, "x"),
                        e("input", {
                          className: "form-control",
                          placeholder: "Anzahl",
                          value: r.n,
                          onChange: ev => updateRow(i, "n", ev.target.value)
                        })
                      )
                    )
                  )
                ),

                e("hr", { className: "my-4" }),

                e("div", { className: "row g-3" },
                  e("div", { className: "col-12 col-md-4" },
                    e("label", { className: "form-label" }, "Max. Abweichung (%)"),
                    e("input", {
                      type: "number",
                      className: "form-control",
                      value: maxDev,
                      onChange: ev => setMaxDev(+ev.target.value)
                    })
                  ),
                  e("div", { className: "col-12 col-md-4" },
                    e("label", { className: "form-label" }, "Toleranz − (mm)"),
                    e("input", {
                      type: "number",
                      step: "0.1",
                      className: "form-control",
                      value: tolMinus,
                      onChange: ev => setTolMinus(+ev.target.value)
                    })
                  ),
                  e("div", { className: "col-12 col-md-4" },
                    e("label", { className: "form-label" }, "Toleranz + (mm)"),
                    e("input", {
                      type: "number",
                      step: "0.1",
                      className: "form-control",
                      value: tolPlus,
                      onChange: ev => setTolPlus(+ev.target.value)
                    })
                  )
                ),

                e("div", { className: "mt-4" },
                  e("label", { className: "form-label" }, "PDF-Dateiname (optional)"),
                  e("input", {
                    className: "form-control",
                    placeholder: "z.B. drahtkombination_01",
                    value: pdfName,
                    onChange: ev => setPdfName(ev.target.value)
                  }),
                  e("div", { className: "mt-3 d-flex flex-wrap gap-2" },
                    // ✅ Nur EIN PDF-Button (kein doppelter Button mehr)
                    e("button", { className: "btn btn-success", onClick: savePDF }, "Als PDF speichern")
                  )
                ),

                status
                  ? e("div", { className: "alert alert-warning mt-4 mb-0" }, status)
                  : null
              )
            )
          ),

          // Ergebnisse
          e("div", { className: "col-12 col-lg-5" },
            e("div", { className: "card card-soft rounded-4" },
              e("div", { className: "card-body p-4" },
                e("h5", { className: "mb-3" }, "Ergebnisse"),

                results.length === 0
                  ? e("div", { className: "text-secondary" },
                      "Noch keine Ergebnisse. Klicke auf ",
                      e("span", { className: "fw-semibold" }, "Berechnen"),
                      "."
                    )
                  : null,

                results.map((r, idx) => {
                  const isPos = r.dev >= 0;
                  return e("div", {
                    key: idx,
                    className: "rounded-4 p-3 mb-3 " + (isPos ? "result-pos" : "result-neg")
                  },
                    e("div", { className: "d-flex justify-content-between align-items-start gap-2" },
                      e("div", null,
                        e("div", { className: "fw-semibold" }, r.title),
                        e("div", { className: "text-secondary small" },
                          "Drähte: ",
                          e("span", { className: "mono" }, r.used.join(", ") + " mm"),
                          " (", r.used.length, "x)"
                        )
                      ),
                      e("span", {
                        className: "badge rounded-pill " + (isPos ? "badge-soft-pos" : "badge-soft-neg")
                      }, isPos ? "positiv" : "negativ")
                    ),

                    e("div", { className: "mt-2" },
                      "Abweichung: ",
                      e("span", { className: "fw-bold mono" }, r.dev.toFixed(2) + " %")
                    )
                  );
                })
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(e(App));
  </script>
</body>
</html>
