<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Drahtkombinator</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f6f7f8;
}
input, button {
  margin: 4px;
  padding: 6px;
}
button {
  cursor: pointer;
}
.result {
  margin-top: 15px;
  padding: 10px;
  border-radius: 6px;
}
.positive { background: #e6fff0; }
.negative { background: #fff0f0; }
</style>
</head>

<body>
<div id="root"></div>

<script>
const e = React.createElement;

function area(d) {
  return Math.PI * d * d / 4;
}

function App() {
  const [rows, setRows] = React.useState(
    Array(4).fill({ d: "", n: "" })
  );
  const [maxDev, setMaxDev] = React.useState(10);
  const [tolMinus, setTolMinus] = React.useState(0.2);
  const [tolPlus, setTolPlus] = React.useState(0.2);
  const [pdfName, setPdfName] = React.useState("");
  const [results, setResults] = React.useState([]);

  function updateRow(i, key, val) {
    const r = [...rows];
    r[i] = { ...r[i], [key]: val };
    setRows(r);
  }

  function calculate() {
    let stock = [];
    let minD = Infinity;
    let maxD = -Infinity;

    rows.forEach(r => {
      const d = parseFloat(r.d);
      const n = parseInt(r.n);
      if (!isNaN(d) && !isNaN(n)) {
        minD = Math.min(minD, d);
        maxD = Math.max(maxD, d);
        for (let i = 0; i < n; i++) stock.push(d);
      }
    });

    if (!stock.length) return;

    const minAllowed = minD - tolMinus;
    const maxAllowed = maxD + tolPlus;
    stock = stock.filter(d => d >= minAllowed && d <= maxAllowed);

    const target = area(minD);
    let combis = [];

    for (let i = 0; i < stock.length && combis.length < 1000; i++) {
      let sum = 0;
      let used = [];
      for (let j = i; j < stock.length; j++) {
        if (used.length >= 4) break;
        sum += area(stock[j]);
        used.push(stock[j]);
        const dev = (sum - target) / target * 100;
        if (Math.abs(dev) <= maxDev) {
          combis.push({ used: [...used], dev });
        }
      }
    }

    let bestPlus = combis
      .filter(c => c.dev >= 0)
      .sort((a, b) => a.dev - b.dev)[0];

    let bestMinus = combis
      .filter(c => c.dev < 0)
      .sort((a, b) => b.dev - a.dev);

    let res = [];
    if (bestPlus) res.push(bestPlus);
    if (bestMinus.length) {
      res.push(bestMinus[bestPlus ? 0 : 1] || bestMinus[0]);
    }

    setResults(res);
  }

  function savePDF() {
    alert("PDF speichern: " + (pdfName || "drahtkombination"));
  }

  return e("div", null,
    e("h2", null, "Drahtkombinator"),

    rows.map((r, i) =>
      e("div", { key: i },
        e("input", {
          placeholder: "Durchmesser mm",
          value: r.d,
          onChange: ev => updateRow(i, "d", ev.target.value)
        }),
        e("input", {
          placeholder: "Anzahl",
          value: r.n,
          onChange: ev => updateRow(i, "n", ev.target.value)
        })
      )
    ),

    e("div", null,
      "Max. Abweichung %: ",
      e("input", { type: "number", value: maxDev, onChange: e => setMaxDev(+e.target.value) }),
      "  - Toleranz mm: ",
      e("input", { type: "number", value: tolMinus, onChange: e => setTolMinus(+e.target.value) }),
      "  + Toleranz mm: ",
      e("input", { type: "number", value: tolPlus, onChange: e => setTolPlus(+e.target.value) })
    ),

    e("div", null,
      e("button", { onClick: calculate }, "Berechnen"),
      e("button", { onClick: () => location.reload() }, "Neue Berechnung starten"),
      e("button", { onClick: savePDF }, "Als PDF speichern"),
      e("input", {
        placeholder: "Dateiname für PDF (optional)",
        value: pdfName,
        onChange: e => setPdfName(e.target.value)
      })
    ),

    results.map((r, i) =>
      e("div", {
        key: i,
        className: "result " + (r.dev >= 0 ? "positive" : "negative")
      },
        e("h4", null,
          i === 0
            ? r.dev >= 0 ? "Kombination 1 (beste +)" : "Kombination 1 (beste −)"
            : "Kombination 2 (zweitbeste −)"
        ),
        e("div", null, "Drähte: ", r.used.join(", "), " mm"),
        e("div", null, "Abweichung: ", r.dev.toFixed(2), " %")
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
</body>
</html>
