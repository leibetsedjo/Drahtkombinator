<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Drahtkombination</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background-color: white; }

    .kombiblock {
      background: #f8f9fa;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .kombigruppe-header {
      background-color: #007bff;
      color: white;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ‚úÖ Print/PDF Styling */
    @media print {
      .no-print { display: none !important; }
      .container { max-width: 100% !important; }
      body { background: #fff !important; }
      .kombigruppe-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .alert { border: 1px solid #bcd; }
      /* Lagerbereich f√ºr Druck ausblenden (kannst du entfernen, wenn du Lager mitdrucken willst) */
      #lagerVerwaltung { display: none !important; }
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <h1 class="text-center text-danger">Drahtkombination</h1>

    <div id="drahtEingabe" class="mb-3">
      <!-- 5 Eingabezeilen f√ºr Durchmesser und Anzahl -->
      <div class="row mb-2">
        <div class="col"><input type="number" step="0.01" class="form-control durchmesser" placeholder="Durchmesser (mm)"></div>
        <div class="col"><input type="number" class="form-control anzahl" placeholder="Anzahl"></div>
      </div>
      <div class="row mb-2">
        <div class="col"><input type="number" step="0.01" class="form-control durchmesser" placeholder="Durchmesser (mm)"></div>
        <div class="col"><input type="number" class="form-control anzahl" placeholder="Anzahl"></div>
      </div>
      <div class="row mb-2">
        <div class="col"><input type="number" step="0.01" class="form-control durchmesser" placeholder="Durchmesser (mm)"></div>
        <div class="col"><input type="number" class="form-control anzahl" placeholder="Anzahl"></div>
      </div>
      <div class="row mb-2">
        <div class="col"><input type="number" step="0.01" class="form-control durchmesser" placeholder="Durchmesser (mm)"></div>
        <div class="col"><input type="number" class="form-control anzahl" placeholder="Anzahl"></div>
      </div>
      <div class="row mb-3">
        <div class="col"><input type="number" step="0.01" class="form-control durchmesser" placeholder="Durchmesser (mm)"></div>
        <div class="col"><input type="number" class="form-control anzahl" placeholder="Anzahl"></div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3 no-print">
      <button class="btn btn-success" onclick="berechneZiel()">üßÆ Berechnen</button>
      <button class="btn btn-outline-secondary" onclick="neueBerechnung()">‚ôªÔ∏è Neue Berechnung</button>
      <button class="btn btn-warning" onclick="pdfAusgabe()">üñ®Ô∏è PDF Ausgabe</button>
      <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#lagerVerwaltung">üì¶ Lager</button>
    </div>

    <div class="alert alert-info text-center" id="gesamtQuerschnitt">
      Gesamtquerschnitt: <strong>0.0000 mm¬≤</strong>
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold">Abweichung:</label>
      <div class="row g-2 mb-2">
        <div class="col-md-4">
          <label for="abweichungUnter" class="form-label">Unterhalb (mm):</label>
          <input type="number" step="0.01" id="abweichungUnter" class="form-control" value="0.2">
        </div>
        <div class="col-md-4">
          <label for="abweichungOber" class="form-label">Oberhalb (mm):</label>
          <input type="number" step="0.01" id="abweichungOber" class="form-control" value="0.2">
        </div>
        <div class="col-md-4">
          <label for="abweichungProzent" class="form-label">Abweichung Zielquerschnitt (%):</label>
          <input type="number" step="0.1" id="abweichungProzent" class="form-control" value="10">
        </div>
      </div>
    </div>

    <div>
      <div class="kombigruppe mb-3">
        <div class="kombigruppe-header" data-bs-toggle="collapse" data-bs-target="#positivKombis" aria-expanded="true">
          üî∫ Kombinationen mit gr√∂√üerem Querschnitt
        </div>
        <div class="collapse show" id="positivKombis">
          <div class="kombiliste" id="kombisPositiv"></div>
        </div>
      </div>

      <div class="kombigruppe mb-3">
        <div class="kombigruppe-header" data-bs-toggle="collapse" data-bs-target="#negativKombis" aria-expanded="true">
          üîª Kombinationen mit kleinerem Querschnitt
        </div>
        <div class="collapse show" id="negativKombis">
          <div class="kombiliste" id="kombisNegativ"></div>
        </div>
      </div>
    </div>

    <!-- Lager ist standardm√§√üig zu -->
    <div class="collapse" id="lagerVerwaltung">
      <div class="card card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <h5 class="mb-0">Lagerverwaltung</h5>

          <!-- ‚úÖ Reset-Button √∂ffnet Modal -->
          <button class="btn btn-sm btn-outline-primary no-print" onclick="openResetModal()">
            üîÅ Standardlager wiederherstellen
          </button>
        </div>

        <div class="input-group mb-2 mt-3 no-print">
          <input type="number" step="0.01" class="form-control" placeholder="Neuer Drahtdurchmesser" id="lagerEingabe">
          <button class="btn btn-success" onclick="lagerHinzufuegen()">‚ûï Hinzuf√ºgen</button>
        </div>

        <div id="lagerListe" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Best√§tigungs-Modal -->
  <div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resetModalLabel">Standardlager wiederherstellen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schlie√üen"></button>
        </div>
        <div class="modal-body">
          Willst du das Lager wirklich auf die Standardliste zur√ºcksetzen?
          <div class="text-muted mt-2" style="font-size: 0.95rem;">
            Deine aktuellen Lager-Eintr√§ge/√Ñnderungen werden √ºberschrieben.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="button" class="btn btn-primary" onclick="confirmResetStandardlager()">
            Ja, zur√ºcksetzen
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let lager = [];

    // ‚úÖ Standard-Lagerwerte
    const STANDARD_LAGER = [
      0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60,
      0.70, 0.75, 0.80,
      1.06, 1.12, 1.18, 1.20, 1.25
    ].map(d => ({ d, aktiv: true }));

    function speichernLager() {
      localStorage.setItem('drahtlager', JSON.stringify(lager));
    }

    function neueBerechnung() {
      document.querySelectorAll('.durchmesser, .anzahl').forEach(el => el.value = '');
      document.getElementById('gesamtQuerschnitt').innerHTML =
        'Gesamtquerschnitt: <strong>0.0000 mm¬≤</strong>';
      document.getElementById('kombisPositiv').innerHTML = '';
      document.getElementById('kombisNegativ').innerHTML = '';
      const first = document.querySelector('.durchmesser');
      if (first) first.focus();
    }

    // ‚úÖ Modal √∂ffnen
    function openResetModal() {
      const el = document.getElementById('resetModal');
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    // ‚úÖ Reset nach Best√§tigung
    function confirmResetStandardlager() {
      lager = STANDARD_LAGER.map(e => ({ d: e.d, aktiv: e.aktiv }));
      speichernLager();
      lagerAnzeigen();

      const el = document.getElementById('resetModal');
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.hide();
    }

    // ‚úÖ PDF-Ausgabe: Browser Druckdialog ‚Üí ‚ÄúAls PDF speichern‚Äù
    function pdfAusgabe() {
      // optional: Lager sicher zu (f√ºr sauberes PDF)
      const lagerEl = document.getElementById('lagerVerwaltung');
      if (lagerEl.classList.contains('show')) {
        bootstrap.Collapse.getOrCreateInstance(lagerEl).hide();
      }

      // Druckdialog √∂ffnen (User w√§hlt ‚ÄúAls PDF speichern‚Äù)
      window.print();
    }

    function lagerAnzeigen() {
      const liste = document.getElementById('lagerListe');
      liste.innerHTML = '';

      if (!lager.length) {
        liste.innerHTML = '<div class="text-muted">(Noch keine Dr√§hte im Lager)</div>';
        return;
      }

      lager.sort((a, b) => a.d - b.d);

      lager.forEach((eintrag, index) => {
        const zeile = document.createElement('div');
        zeile.className = 'd-flex justify-content-between align-items-center mb-2';

        const text = document.createElement('span');
        text.textContent = `${eintrag.d.toFixed(2)} mm`;

        const btns = document.createElement('div');
        btns.className = 'btn-group no-print';

        const aktiv = eintrag.aktiv !== false;

        const aktivBtn = document.createElement('button');
        aktivBtn.className = 'btn btn-sm ' + (aktiv ? 'btn-success' : 'btn-danger');
        aktivBtn.textContent = aktiv ? 'Aktiv' : 'Inaktiv';
        aktivBtn.onclick = () => {
          lager[index].aktiv = !lager[index].aktiv;
          speichernLager();
          lagerAnzeigen();
        };

        const loeschBtn = document.createElement('button');
        loeschBtn.className = 'btn btn-sm btn-outline-danger';
        loeschBtn.textContent = 'L√∂schen';
        loeschBtn.onclick = () => {
          lager.splice(index, 1);
          speichernLager();
          lagerAnzeigen();
        };

        btns.appendChild(aktivBtn);
        btns.appendChild(loeschBtn);
        zeile.appendChild(text);
        zeile.appendChild(btns);
        liste.appendChild(zeile);
      });
    }

    function lagerHinzufuegen() {
      const eingabe = document.getElementById('lagerEingabe');
      const wert = Number(eingabe.value);

      if (!Number.isFinite(wert) || wert <= 0) {
        eingabe.focus();
        return;
      }

      // keine Duplikate
      const exists = lager.some(e => Math.abs(e.d - wert) < 1e-9);
      if (exists) {
        eingabe.value = '';
        return;
      }

      lager.push({ d: wert, aktiv: true });
      speichernLager();
      lagerAnzeigen();
      eingabe.value = '';
    }

    function berechneZiel() {
      const dInputs = document.querySelectorAll('.durchmesser');
      const nInputs = document.querySelectorAll('.anzahl');

      let summe = 0;
      let minEingabe = Infinity;
      let maxEingabe = -Infinity;

      for (let i = 0; i < dInputs.length; i++) {
        const dVal = dInputs[i].value.trim();
        const nVal = nInputs[i].value.trim();
        if (dVal === '' || nVal === '') continue;

        const d = Number(dVal);
        const n = Number(nVal);

        if (!Number.isFinite(d) || d <= 0) continue;
        if (!Number.isInteger(n) || n <= 0) continue;

        const a = n * Math.PI * Math.pow(d / 2, 2);
        summe += a;
        if (d < minEingabe) minEingabe = d;
        if (d > maxEingabe) maxEingabe = d;
      }

      if (!Number.isFinite(summe) || summe <= 0 || !isFinite(minEingabe) || !isFinite(maxEingabe)) {
        document.getElementById('gesamtQuerschnitt').innerHTML =
          `Gesamtquerschnitt: <strong>0.0000 mm¬≤</strong>`;
        document.getElementById('kombisPositiv').innerHTML = '';
        document.getElementById('kombisNegativ').innerHTML = '';
        return;
      }

      const ziel = summe;
      document.getElementById('gesamtQuerschnitt').innerHTML =
        `Gesamtquerschnitt: <strong>${ziel.toFixed(4)} mm¬≤</strong>`;

      berechneKombinationen(ziel, minEingabe, maxEingabe);
    }

    function berechneKombinationen(ziel, minE, maxE) {
      const abwMMU = Number(document.getElementById('abweichungUnter').value);
      const abwMMO = Number(document.getElementById('abweichungOber').value);
      const abwProzent = Number(document.getElementById('abweichungProzent').value);

      const safeAbwMMU = Number.isFinite(abwMMU) ? abwMMU : 0;
      const safeAbwMMO = Number.isFinite(abwMMO) ? abwMMO : 0;
      const safeAbwProzent = Number.isFinite(abwProzent) ? abwProzent : 0;

      const dMin = minE - safeAbwMMU;
      const dMax = maxE + safeAbwMMO;
      const delta = ziel * (safeAbwProzent / 100);

      const aktiveD = lager.filter(e =>
        e.aktiv && Number.isFinite(e.d) && e.d >= dMin && e.d <= dMax
      );

      const dList = [...new Set(aktiveD.map(e => e.d))].sort((a, b) => a - b);

      const outPos = document.getElementById('kombisPositiv');
      const outNeg = document.getElementById('kombisNegativ');
      outPos.innerHTML = '';
      outNeg.innerHTML = '';

      if (!dList.length) {
        outPos.innerHTML = '<div class="text-muted">Keine aktiven Lagerdr√§hte im passenden Durchmesserbereich.</div>';
        outNeg.innerHTML = '<div class="text-muted">Keine aktiven Lagerdr√§hte im passenden Durchmesserbereich.</div>';
        return;
      }

      const areaByD = new Map();
      for (const d of dList) areaByD.set(d, Math.PI * Math.pow(d / 2, 2));

      function kombiText(kombi) {
        const zaehler = new Map();
        for (const d of kombi) zaehler.set(d, (zaehler.get(d) || 0) + 1);
        return [...zaehler.entries()]
          .sort((a, b) => a[0] - b[0])
          .map(([d, n]) => `${n}x ${Number(d).toFixed(2)} mm`)
          .join('<br>');
      }

      function erstelleBlock(kombi, querschnitt) {
        const abw = querschnitt - ziel;
        const abwRel = (abw / ziel) * 100;
        return `
          <div class="kombiblock">
            ${kombiText(kombi)}<br>
            <strong>${querschnitt.toFixed(4)} mm¬≤</strong><br>
            Abweichung: ${abwRel.toFixed(2)}% (${abw.toFixed(4)} mm¬≤)
          </div>`;
      }

      const topPos = [];
      const topNeg = [];

      function tryInsert(list, candidate, limit = 5) {
        list.push(candidate);
        list.sort((a, b) => a.diffAbs - b.diffAbs || a.len - b.len);
        if (list.length > limit) list.pop();
      }

      const maxArea = areaByD.get(dList[dList.length - 1]);

      function dfs(kombi, startIndex, currentSum) {
        const len = kombi.length;

        if (len > 0) {
          const diff = currentSum - ziel;
          const diffAbs = Math.abs(diff);

          if (diffAbs <= delta) {
            const candidate = { draehte: [...kombi], q: currentSum, diffAbs, len };
            if (diff >= 0) tryInsert(topPos, candidate);
            else tryInsert(topNeg, candidate);
          }
        }

        if (len >= 5) return;
        if (currentSum > ziel + delta) return;

        const rest = 5 - len;
        const bestPossibleMax = currentSum + rest * maxArea;
        if (bestPossibleMax < ziel - delta) return;

        for (let i = startIndex; i < dList.length; i++) {
          const d = dList[i];
          const a = areaByD.get(d);
          kombi.push(d);
          dfs(kombi, i, currentSum + a);
          kombi.pop();
        }
      }

      dfs([], 0, 0);

      outPos.innerHTML = topPos.length
        ? topPos.map(k => erstelleBlock(k.draehte, k.q)).join('')
        : '<div class="text-muted">Keine passenden Kombinationen gefunden.</div>';

      outNeg.innerHTML = topNeg.length
        ? topNeg.map(k => erstelleBlock(k.draehte, k.q)).join('')
        : '<div class="text-muted">Keine passenden Kombinationen gefunden.</div>';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const gespeicherte = localStorage.getItem('drahtlager');

      if (gespeicherte) {
        try {
          lager = JSON.parse(gespeicherte).map(e => ({
            d: Number(e.d),
            aktiv: e.aktiv !== false
          })).filter(e => Number.isFinite(e.d) && e.d > 0);
        } catch {
          lager = [];
        }
      }

      // Wenn noch kein Lager existiert: Standardlager setzen
      if (!lager.length) {
        lager = STANDARD_LAGER.map(e => ({ d: e.d, aktiv: e.aktiv }));
        speichernLager();
      }

      lagerAnzeigen();
    });
  </script>
</body>
</html>
